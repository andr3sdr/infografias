<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Rsyslog: Facilidades y Protocolos</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --box-bg: #313244;
            --text-color: #cdd6f4;
            
            /* Colores de Severidad */
            --sev-info: #a6e3a1; /* Verde */
            --sev-warn: #f9e2af; /* Amarillo */
            --sev-err: #f38ba8;  /* Rojo */

            /* Colores de Componentes */
            --comp-rsyslog: #89b4fa;
            --comp-file: #fab387;
            --comp-network: #cba6f7;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto;
            padding-bottom: 50px;
            user-select: none;
        }

        h2 { margin-top: 20px; margin-bottom: 5px; }
        p.subtitle { color: #a6adc8; font-size: 0.9em; margin-bottom: 25px; }

        /* --- 1. CONTENEDOR DEL DIAGRAMA --- */
        #diagram-container {
            position: relative;
            width: 900px;
            height: 480px;
            background: #181825;
            border-radius: 12px 12px 0 0;
            border: 1px solid #45475a;
            border-bottom: none;
            flex-shrink: 0;
            overflow: hidden;
        }

        /* --- 2. CONSOLA DE LOGS --- */
        #console {
            position: relative;
            width: 900px;
            height: 120px;
            background: #11111b;
            border: 1px solid #45475a;
            border-top: 1px solid #313244;
            border-radius: 0 0 12px 12px;
            padding: 15px;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #a6adc8;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 25px;
            display: flex;
            flex-direction: column-reverse;
        }
        
        .log-line { 
            margin-bottom: 4px; 
            border-bottom: 1px solid #313244; 
            padding-bottom: 2px; 
            flex-shrink: 0;
        }

        /* Nodos Generales */
        .node {
            position: absolute;
            background: var(--box-bg);
            border: 2px solid #585b70;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            width: 110px;
            font-size: 0.85em;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .node-icon { font-size: 1.5em; display: block; margin-bottom: 5px; }

        /* --- NODO INTERACTIVO (RSYSLOGD) --- */
        #daemon-rsyslog { 
            top: 170px; left: 350px; 
            width: 160px; height: 120px;
            border-color: var(--comp-rsyslog);
            background: #2a2b3d;
            display: flex; flex-direction: column; justify-content: center;
            cursor: pointer; /* Indicar clic */
            animation: breathe 3s infinite ease-in-out;
        }

        #daemon-rsyslog:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--comp-rsyslog);
            background: #36384a;
        }

        #daemon-rsyslog::after {
            content: "üëÜ Clic para configurar";
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--comp-rsyslog);
            color: #1e1e2e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #daemon-rsyslog:hover::after { opacity: 1; }

        @keyframes breathe {
            0%, 100% { border-color: var(--comp-rsyslog); }
            50% { border-color: #b4befe; }
        }

        /* Resto de Nodos */
        #input-ssh { top: 40px; left: 30px; border-color: var(--sev-warn); }
        #input-kernel { top: 190px; left: 30px; border-color: var(--sev-err); }
        #input-app { top: 340px; left: 30px; border-color: var(--sev-info); }

        #file-auth { top: 40px; right: 150px; border-color: var(--comp-file); }
        #file-kern { top: 160px; right: 150px; border-color: var(--comp-file); }
        #file-syslog { top: 270px; right: 150px; border-color: var(--comp-file); }

        #out-network { 
            top: 370px; right: 50px; 
            width: 200px;
            border-color: var(--comp-network); 
            background: #232433;
            transition: all 0.3s;
        }

        /* --- VENTANA MODAL DE CONFIGURACI√ìN --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e1e2e;
            margin: 10% auto; 
            padding: 25px;
            border: 1px solid #45475a;
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover { color: #fff; }

        .rule-row {
            background: #313244;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            border-left: 4px solid transparent;
            transition: border-left-color 0.2s;
        }
        
        .rule-row:hover { background: #3a3c52; }
        .rule-row.active { border-left-color: var(--sev-info); }
        .rule-row.inactive { border-left-color: #45475a; opacity: 0.6; }

        input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
            cursor: pointer;
        }

        label { 
            font-family: 'Courier New', monospace; 
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
        }

        .info-box {
            background: #232433;
            border: 1px solid #89b4fa;
            color: #cdd6f4;
            padding: 10px;
            font-size: 0.9em;
            border-radius: 6px;
            margin-top: 20px;
        }

        /* --- 3. PANEL DE CONTROL --- */
        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            width: 900px;
            flex-shrink: 0;
        }

        .control-group {
            background: #313244;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #45475a;
        }

        .control-title {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #9399b2;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #45475a;
            padding-bottom: 5px;
        }

        button {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: transform 0.1s, filter 0.2s;
            color: #181825;
        }
        button:active { transform: scale(0.96); }
        button:hover { filter: brightness(1.1); }

        .btn-event { background: #cdd6f4; }
        .btn-ssh { background: #f9e2af; }
        .btn-kern { background: #f38ba8; }
        .btn-app { background: #a6e3a1; }

        /* Switch Protocolo */
        .proto-switch {
            display: flex;
            background: #181825;
            border-radius: 6px;
            padding: 4px;
            margin-top: 10px;
        }
        .proto-opt {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 0.85em;
            cursor: pointer;
            border-radius: 4px;
            color: #7f849c;
        }
        .proto-opt.active {
            background: var(--comp-network);
            color: #1e1e2e;
            font-weight: bold;
        }

        /* Canvas */
        #anim-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* Animaciones CSS */
        .pulse { animation: pulse 0.4s ease-out; }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <h2>Laboratorio de Logs Linux</h2>
    <p class="subtitle">Simula eventos y modifica las reglas de rsyslog haciendo clic en el nodo central</p>

    <!-- 1. DIAGRAMA VISUAL -->
    <div id="diagram-container">
        <canvas id="anim-canvas"></canvas>

        <!-- Entradas -->
        <div id="input-ssh" class="node">
            <span class="node-icon">üîí</span>
            AUTH / PRIV
            <div style="font-size:0.7em; color:#f9e2af">Logins, Sudo</div>
        </div>
        <div id="input-kernel" class="node">
            <span class="node-icon">‚öôÔ∏è</span>
            KERN
            <div style="font-size:0.7em; color:#f38ba8">Hardware, Drivers</div>
        </div>
        <div id="input-app" class="node">
            <span class="node-icon">üì±</span>
            DAEMON / USER
            <div style="font-size:0.7em; color:#a6e3a1">Apps, Cron</div>
        </div>

        <!-- Procesador (AHORA INTERACTIVO) -->
        <div id="daemon-rsyslog" class="node" onclick="openConfigModal()">
            <span class="node-icon">üîÑ</span>
            RSYSLOGD
            <div id="rules-display" style="font-size:0.7em; margin-top:5px; color:#fff">
                <!-- Se rellena por JS -->
            </div>
        </div>

        <!-- Salidas Locales -->
        <div id="file-auth" class="node">
            üìÑ auth.log
        </div>
        <div id="file-kern" class="node">
            üìÑ kern.log
        </div>
        <div id="file-syslog" class="node">
            üìÑ syslog
        </div>

        <!-- Salida Remota -->
        <div id="out-network" class="node" style="opacity: 0.5;">
            <span class="node-icon">üåê</span>
            Servidor Remoto
            <div style="font-size:0.7em; margin-top:5px;">Destino de Logs Centralizado</div>
        </div>
    </div>

    <!-- 2. CONSOLA DE LOGS -->
    <div id="console">
        <div class="log-line" style="color:#89b4fa">> Sistema listo. Haz clic en 'RSYSLOGD' para ver la configuraci√≥n.</div>
    </div>

    <!-- 3. PANEL DE CONTROL -->
    <div id="controls">
        <!-- Generador -->
        <div class="control-group">
            <span class="control-title">1. Generar Eventos</span>
            <button class="btn-ssh" onclick="spawnLog('auth', 'warn')">Simular: Login Fallido (SSH)</button>
            <button class="btn-kern" onclick="spawnLog('kern', 'err')">Simular: Error Disco (Kernel)</button>
            <button class="btn-app" onclick="spawnLog('daemon', 'info')">Simular: Tarea Cron (Info)</button>
        </div>

        <!-- Configuraci√≥n Remota -->
        <div class="control-group">
            <span class="control-title">2. Configuraci√≥n Remota</span>
            <div style="font-size: 0.85em; margin-bottom: 5px;">¬øEnviar copias al servidor?</div>
            <button id="btn-toggle-remote" onclick="toggleRemote()" style="background:#45475a; color:white;">Activar Env√≠o Remoto</button>
            
            <div id="proto-selector" style="opacity: 0.3; pointer-events: none;">
                <div style="font-size: 0.85em; margin-top: 10px;">Protocolo de Transporte:</div>
                <div class="proto-switch">
                    <div class="proto-opt active" id="opt-udp" onclick="setProto('udp')">UDP (R√°pido/Inseguro)</div>
                    <div class="proto-opt" id="opt-tcp" onclick="setProto('tcp')">TCP (Lento/Fiable)</div>
                </div>
            </div>
        </div>

        <!-- Leyenda -->
        <div class="control-group">
            <span class="control-title">Leyenda Pedag√≥gica</span>
            <div style="font-size: 0.8em; line-height: 1.6;">
                <span style="color:var(--sev-err)">‚óè Rojo:</span> Severidad Alta (Error/Crit)<br>
                <span style="color:var(--sev-warn)">‚óè Amarillo:</span> Severidad Media (Warning)<br>
                <span style="color:var(--sev-info)">‚óè Verde:</span> Informativo (Info/Debug)<br>
                <br>
                <i>Nota: En modo UDP, observar√°s p√©rdida de paquetes aleatoria simulada.</i>
            </div>
        </div>
    </div>

    <!-- 4. MODAL DE CONFIGURACI√ìN -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeConfigModal()">&times;</span>
            <h3 style="margin-top:0">Configuraci√≥n: /etc/rsyslog.conf</h3>
            <p style="color:#a6adc8; font-size:0.9em">Activa o desactiva reglas para ver c√≥mo afecta al ruteo de logs.</p>

            <!-- Regla AUTH -->
            <div class="rule-row active" id="row-auth">
                <input type="checkbox" id="chk-auth" checked onchange="updateRules()">
                <label for="chk-auth">
                    <span style="color:var(--sev-warn)">auth,authpriv.*</span> 
                    <span style="color:#aaa">&nbsp;&nbsp;/var/log/auth.log</span>
                </label>
            </div>

            <!-- Regla KERN -->
            <div class="rule-row active" id="row-kern">
                <input type="checkbox" id="chk-kern" checked onchange="updateRules()">
                <label for="chk-kern">
                    <span style="color:var(--sev-err)">kern.*</span> 
                    <span style="color:#aaa">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/var/log/kern.log</span>
                </label>
            </div>

            <!-- Regla DEFAULT -->
            <div class="rule-row active" style="opacity:0.8">
                <input type="checkbox" checked disabled>
                <label>
                    <span style="color:var(--sev-info)">*.*</span> 
                    <span style="color:#aaa">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/var/log/syslog</span>
                </label>
            </div>

            <div class="info-box">
                <strong>¬øQu√© ocurre si desactivo una regla?</strong><br>
                Rsyslog procesa las reglas en orden. Si desactivas la regla espec√≠fica (ej. auth), los mensajes no desaparecen; "caen" hasta la regla gen√©rica (*.*) y se guardan en <code>syslog</code>.
            </div>
        </div>
    </div>

<script>
    /* --- CONFIGURACI√ìN Y ESTADO --- */
    const canvas = document.getElementById('anim-canvas');
    const ctx = canvas.getContext('2d');
    
    let remoteActive = false;
    let protocol = 'udp'; // udp | tcp
    let packets = [];
    const elements = {};
    
    // Configuraci√≥n de Reglas (Simulando rsyslog.conf)
    let activeRules = {
        auth: true,
        kern: true
    };

    /* --- INICIALIZACI√ìN --- */
    function init() {
        resize();
        window.addEventListener('resize', resize);
        updateRulesDisplay(); // Mostrar reglas iniciales
        requestAnimationFrame(loop);
    }

    function resize() {
        const container = document.getElementById('diagram-container');
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
        
        // Mapear coordenadas de los nodos DOM
        const ids = ['input-ssh', 'input-kernel', 'input-app', 'daemon-rsyslog', 
                     'file-auth', 'file-kern', 'file-syslog', 'out-network'];
        
        const containerRect = container.getBoundingClientRect();
        
        ids.forEach(id => {
            const el = document.getElementById(id);
            const rect = el.getBoundingClientRect();
            elements[id] = {
                x: rect.left - containerRect.left + rect.width/2,
                y: rect.top - containerRect.top + rect.height/2,
                w: rect.width,
                h: rect.height,
                id: id
            };
        });
    }

    /* --- L√ìGICA DE PAQUETES --- */
    class LogPacket {
        constructor(facility, severity) {
            this.facility = facility; // auth, kern, daemon
            this.severity = severity; // err, warn, info
            this.progress = 0;
            this.stage = 0; // 0: Input->Daemon, 1: Daemon->Files/Net
            this.dead = false;
            this.id = Math.floor(Math.random()*1000);

            // Estilo visual
            this.color = severity === 'err' ? '#f38ba8' : (severity === 'warn' ? '#f9e2af' : '#a6e3a1');
            this.size = 6;
            
            // Ruta inicial
            this.setPath(0);
        }

        setPath(stage) {
            this.stage = stage;
            this.progress = 0;

            if (stage === 0) {
                // Etapa 1: Origen -> Rsyslog
                let startId = 'input-app';
                if (this.facility === 'auth') startId = 'input-ssh';
                if (this.facility === 'kern') startId = 'input-kernel';
                
                this.start = elements[startId];
                this.end = elements['daemon-rsyslog'];
                this.speed = 0.02;

                pulseDOM(startId);
            } 
            else if (stage === 1) {
                // Etapa 2: Rsyslog -> Archivo (CON L√ìGICA DE REGLAS)
                this.start = elements['daemon-rsyslog'];
                this.speed = 0.015;

                // L√≥gica din√°mica basada en el modal
                if (this.facility === 'auth') {
                    // Si la regla Auth est√° activa -> auth.log, sino -> syslog
                    this.end = activeRules.auth ? elements['file-auth'] : elements['file-syslog'];
                }
                else if (this.facility === 'kern') {
                    // Si la regla Kern est√° activa -> kern.log, sino -> syslog
                    this.end = activeRules.kern ? elements['file-kern'] : elements['file-syslog'];
                }
                else {
                    // Resto (daemon, user, etc) -> syslog
                    this.end = elements['file-syslog'];
                }
            }
            else if (stage === 2) {
                // Etapa 3 (Opcional): Copia a Red
                this.start = elements['daemon-rsyslog'];
                this.end = elements['out-network'];
                
                // TCP es m√°s lento (simulado)
                this.speed = protocol === 'tcp' ? 0.01 : 0.025; 
            }
        }

        update() {
            this.progress += this.speed;

            // Simulaci√≥n de p√©rdida de paquetes UDP
            if (this.stage === 2 && protocol === 'udp' && !this.dead) {
                // 15% de probabilidad de p√©rdida a mitad de camino
                if (this.progress > 0.4 && this.progress < 0.5 && Math.random() < 0.05) {
                    this.dead = true;
                    logMsg(`‚ö†Ô∏è Paquete UDP #${this.id} perdido en la red!`, 'err');
                    return;
                }
            }

            if (this.progress >= 1) {
                if (this.stage === 0) {
                    // Lleg√≥ al demonio
                    pulseDOM('daemon-rsyslog');
                    
                    // Al llegar al demonio, se bifurca
                    // 1. Siempre va al disco local (pasamos a stage 1)
                    this.setPath(1);

                    // 2. Si red est√° activa, creamos un CLON para ir a la red
                    if (remoteActive) {
                        const netPacket = new LogPacket(this.facility, this.severity);
                        netPacket.id = this.id; // Mismo ID para identificarlo
                        netPacket.setPath(2); // Ruta de red direct
                        packets.push(netPacket);
                    }
                } 
                else if (this.stage === 1) {
                    // Lleg√≥ al archivo
                    pulseDOM(this.end.id);
                    const fileName = this.end.id.replace('file-', '') + '.log';
                    logMsg(`üíæ Guardado en ${fileName}`, 'info');
                    this.dead = true;
                }
                else if (this.stage === 2) {
                    // Lleg√≥ a la red
                    pulseDOM('out-network');
                    logMsg(`üåê Recibido en Server Remoto (v√≠a ${protocol.toUpperCase()})`, 'ok');
                    this.dead = true;
                }
            }
        }

        draw() {
            if (this.dead) return;
            
            const dx = this.end.x - this.start.x;
            const dy = this.end.y - this.start.y;
            const x = this.start.x + dx * this.progress;
            const y = this.start.y + dy * this.progress;

            ctx.fillStyle = this.color;
            ctx.shadowBlur = 10;
            ctx.shadowColor = this.color;
            ctx.beginPath();
            ctx.arc(x, y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            if (this.stage === 2) {
                ctx.fillStyle = "#fff";
                ctx.font = "10px Arial";
                ctx.fillText(protocol === 'udp' ? 'U' : 'T', x + 8, y - 5);
            }
        }
    }

    /* --- FUNCIONES DE CONTROL --- */
    function spawnLog(facility, severity) {
        const p = new LogPacket(facility, severity);
        packets.push(p);
        
        let msg = "";
        if(facility === 'auth') msg = "Intento fallido de contrase√±a para root";
        if(facility === 'kern') msg = "I/O Error: dev sda1 sector 34234";
        if(facility === 'daemon') msg = "CRON[102]: (root) CMD (backup.sh)";
        
        logMsg(`Nuevo evento [${facility}.${severity}]: ${msg}`, 'sys');
    }

    function toggleRemote() {
        remoteActive = !remoteActive;
        const btn = document.getElementById('btn-toggle-remote');
        const netNode = document.getElementById('out-network');
        const selector = document.getElementById('proto-selector');

        if (remoteActive) {
            btn.style.background = "#a6e3a1";
            btn.style.color = "#181825";
            btn.innerText = "Env√≠o Remoto ACTIVADO";
            netNode.style.opacity = "1";
            selector.style.opacity = "1";
            selector.style.pointerEvents = "auto";
        } else {
            btn.style.background = "#45475a";
            btn.style.color = "white";
            btn.innerText = "Activar Env√≠o Remoto";
            netNode.style.opacity = "0.5";
            selector.style.opacity = "0.3";
            selector.style.pointerEvents = "none";
        }
    }

    function setProto(p) {
        protocol = p;
        document.getElementById('opt-udp').className = `proto-opt ${p==='udp'?'active':''}`;
        document.getElementById('opt-tcp').className = `proto-opt ${p==='tcp'?'active':''}`;
        logMsg(`Protocolo cambiado a ${p.toUpperCase()}. ${p==='tcp'?'Conexi√≥n fiable.':'Sin garant√≠a de entrega.'}`, 'sys');
    }

    /* --- GESTI√ìN DEL MODAL Y REGLAS --- */
    function openConfigModal() {
        document.getElementById('configModal').style.display = 'block';
    }

    function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
    }

    function updateRules() {
        activeRules.auth = document.getElementById('chk-auth').checked;
        activeRules.kern = document.getElementById('chk-kern').checked;
        
        // Actualizar visualmente el modal
        document.getElementById('row-auth').className = activeRules.auth ? 'rule-row active' : 'rule-row inactive';
        document.getElementById('row-kern').className = activeRules.kern ? 'rule-row active' : 'rule-row inactive';

        updateRulesDisplay();
        logMsg("Configuraci√≥n de rsyslog recargada.", "sys");
    }

    function updateRulesDisplay() {
        const display = document.getElementById('rules-display');
        let html = "Reglas activas:<br>";
        
        if (activeRules.auth) html += "auth.* &rarr; auth.log<br>";
        if (activeRules.kern) html += "kern.* &rarr; kern.log<br>";
        html += "*.* &rarr; syslog"; // Regla base

        display.innerHTML = html;
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('configModal');
        if (event.target == modal) {
            closeConfigModal();
        }
    }

    /* --- UTILIDADES VISUALES --- */
    function pulseDOM(id) {
        const el = document.getElementById(id);
        el.classList.remove('pulse');
        void el.offsetWidth; 
        el.classList.add('pulse');
    }

    function logMsg(text, type) {
        const con = document.getElementById('console');
        const line = document.createElement('div');
        line.className = 'log-line';
        
        let color = '#a6adc8';
        if(type === 'err') color = '#f38ba8';
        if(type === 'ok') color = '#a6e3a1';
        if(type === 'sys') color = '#89b4fa';
        
        line.style.color = color;
        line.innerText = `> ${text}`;
        
        con.prepend(line);
        if(con.children.length > 8) con.lastElementChild.remove();
    }

    /* --- BUCLE PRINCIPAL --- */
    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Dibujar Conexiones (Fondo est√°tico)
        if (elements['daemon-rsyslog']) {
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#313244';
            ctx.beginPath();
            
            const center = elements['daemon-rsyslog'];

            // Entradas
            ['input-ssh', 'input-kernel', 'input-app'].forEach(id => {
                const el = elements[id];
                ctx.moveTo(el.x, el.y);
                ctx.lineTo(center.x, center.y);
            });

            // Salidas Locales
            ['file-auth', 'file-kern', 'file-syslog'].forEach(id => {
                const el = elements[id];
                ctx.moveTo(center.x, center.y);
                ctx.lineTo(el.x, el.y);
            });

            // Salida Remota
            if(remoteActive) {
                const el = elements['out-network'];
                ctx.moveTo(center.x, center.y);
                ctx.lineTo(el.x, el.y);
            }

            ctx.stroke();
        }

        // Actualizar y dibujar paquetes
        for (let i = packets.length - 1; i >= 0; i--) {
            let p = packets[i];
            p.update();
            p.draw();
            if (p.dead) packets.splice(i, 1);
        }

        requestAnimationFrame(loop);
    }

    // Iniciar al cargar
    setTimeout(init, 100);

</script>
</body>
</html>
