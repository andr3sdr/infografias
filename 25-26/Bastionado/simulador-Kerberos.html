<!DOCTYPE html>
<html lang="gl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerberos MasterClass - Simulaci√≥n Interactiva</title>
    <!-- Fuente Inter para una est√©tica m√°s profesional -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }
        .packet-transition {
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .actor-transition {
            transition: all 0.3s ease;
        }
        .step-indicator-transition {
            transition: width 0.5s ease-out;
        }
        /* Estilos para estados de los actores */
        .actor-idle { @apply border-slate-200 text-slate-300 bg-white; }
        .actor-active { @apply border-blue-500 text-blue-600 bg-white shadow-2xl scale-110; }
        .actor-waiting { @apply border-orange-400 text-orange-500 bg-white animate-pulse; }
        .actor-success { @apply border-green-500 text-green-600 bg-white shadow-2xl scale-110; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen p-4 md:p-8 antialiased">

    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col relative">
        
        <!-- HEADER -->
        <header class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white z-10">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight flex items-center gap-3">
                    <i data-lucide="shield-check" class="text-blue-600 w-8 h-8"></i>
                    Kerberos <span class="text-blue-600">MasterClass</span>
                </h1>
                <p class="text-slate-400 text-sm font-medium mt-1">Simulaci√≥n Interactiva de Seguridade en Active Directory</p>
            </div>
            
            <div class="flex bg-slate-50 p-1 rounded-lg shadow-sm border border-slate-200">
                <button id="btn-mode-tech" onclick="setMode('technical')" class="flex items-center gap-2 px-4 py-2 rounded-md text-xs font-semibold transition-all bg-white text-blue-600 shadow-sm border border-slate-100">
                    <i data-lucide="binary" class="w-3.5 h-3.5"></i> Modo T√©cnico
                </button>
                <button id="btn-mode-analogy" onclick="setMode('analogy')" class="flex items-center gap-2 px-4 py-2 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-100">
                    <i data-lucide="layout" class="w-3.5 h-3.5"></i> Modo Estudante
                </button>
            </div>
        </header>

        <div class="flex flex-1 relative">
            <!-- SIDEBAR GLOSARIO (TIPOGRAF√çA MEJORADA) -->
            <aside class="w-56 p-6 border-r border-slate-100 bg-slate-50/30 hidden xl:block">
                <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i data-lucide="book-open" class="w-4 h-4"></i> Glosario
                </h4>
                <div class="space-y-6">
                    <div>
                        <p class="text-sm font-bold text-blue-700 mb-1">NTLM Hash</p>
                        <p class="text-xs text-slate-600 leading-relaxed">Contrasinal 'disfrazado'. Nunca se env√≠a en claro pola rede.</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-indigo-700 mb-1">PAC</p>
                        <p class="text-xs text-slate-600 leading-relaxed">Lista dos teus privilexios e grupos de seguridade do dominio.</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-orange-700 mb-1">SPN</p>
                        <p class="text-xs text-slate-600 leading-relaxed">Nome '√∫nico' do servizo solicitado (ex: cifs/servidor).</p>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-green-700 mb-1">Authenticator</p>
                        <p class="text-xs text-slate-600 leading-relaxed">Proba temporal de identidade para evitar reenv√≠os.</p>
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="flex-1 p-6 flex flex-col gap-6">
                
                <!-- DIAGRAMA -->
                <div class="relative w-full h-[400px] bg-white rounded-3xl border border-slate-100 shadow-inner overflow-hidden select-none" id="diagram-container">
                    <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-20 z-0">
                        <path d="M 120 260 C 120 150, 350 200, 400 120" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="8,8" />
                        <path d="M 140 260 C 140 150, 550 200, 580 120" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="8,8" />
                        <line x1="15%" y1="65%" x2="85%" y2="65%" stroke="#3b82f6" stroke-width="2" stroke-dasharray="8,8" />
                    </svg>

                    <!-- KDC BOX -->
                    <div class="absolute top-[5%] left-1/2 -translate-x-1/2 w-[380px] h-[170px] border-2 border-dashed border-blue-100 rounded-[2.5rem] bg-blue-50/10 flex flex-col items-center pt-2">
                        <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest bg-white px-3 py-1 border border-blue-50 rounded-full shadow-sm mb-2">KDC</span>
                        <div class="flex w-full justify-around items-center h-full pb-4">
                            <div id="actor-as" class="actor-transition flex flex-col items-center p-3 rounded-2xl border-4 bg-white text-slate-300">
                                <i data-lucide="database" class="w-7 h-7"></i>
                                <span class="text-[10px] font-bold mt-2 uppercase tracking-tight">AS</span>
                            </div>
                            <div class="flex flex-col items-center opacity-20 scale-75">
                                <div class="p-2 bg-yellow-400 rounded-lg text-white"><i data-lucide="key" class="w-5 h-5"></i></div>
                            </div>
                            <div id="actor-tgs" class="actor-transition flex flex-col items-center p-3 rounded-2xl border-4 bg-white text-slate-300">
                                <i data-lucide="ticket" class="w-7 h-7"></i>
                                <span class="text-[10px] font-bold mt-2 uppercase tracking-tight">TGS</span>
                            </div>
                        </div>
                    </div>

                    <!-- CLIENTE -->
                    <div class="absolute top-[65%] left-[12%] -translate-x-1/2 flex flex-col items-center">
                        <div id="actor-client" class="actor-transition w-24 h-24 rounded-3xl flex items-center justify-center border-4 border-slate-200 bg-white text-slate-300 shadow-lg">
                            <i data-lucide="user" class="w-10 h-10"></i>
                        </div>
                        <div class="mt-3 text-center">
                            <p class="font-bold text-sm text-slate-700">Usuario</p>
                            <div id="client-inventory" class="flex gap-1 justify-center mt-2 h-6"></div>
                        </div>
                    </div>

                    <!-- SERVICIO -->
                    <div class="absolute top-[65%] right-[12%] translate-x-1/2 flex flex-col items-center">
                        <div id="actor-service" class="actor-transition w-24 h-24 rounded-3xl flex items-center justify-center border-4 border-slate-200 bg-white text-slate-300 shadow-lg">
                            <i data-lucide="server" class="w-10 h-10"></i>
                        </div>
                        <p class="mt-3 font-bold text-sm text-slate-700">Servidor (AP)</p>
                    </div>

                    <!-- PAQUETE -->
                    <div id="packet" onclick="showModal()" class="packet-transition absolute z-30 cursor-pointer hidden group">
                        <div class="relative flex flex-col items-center justify-center w-28 h-20 bg-white border-2 border-blue-600 rounded-2xl shadow-xl bg-gradient-to-br from-white to-blue-50 ring-4 ring-blue-500/10 hover:scale-105 transition-transform">
                            <div id="packet-icons" class="flex items-center gap-2 text-blue-700 mb-1"></div>
                            <span id="packet-label" class="text-[11px] font-bold text-slate-700"></span>
                            <span class="text-[9px] font-bold text-blue-600 animate-pulse mt-1 uppercase tracking-wider text-[8px]">¬°Clic para abrir!</span>
                            <div class="absolute -top-1 -right-1 h-3 w-3 bg-blue-500 rounded-full animate-ping"></div>
                        </div>
                    </div>
                </div>

                <!-- CONTROLES (TIPOGRAF√çA BOTONES MEJORADA) -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 h-1 bg-blue-100 w-full">
                            <div id="progress-bar" class="h-full bg-blue-600 step-indicator-transition" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center mb-4 pt-2">
                            <span id="step-badge" class="px-3 py-1 bg-slate-900 text-white rounded-full text-[10px] font-bold tracking-widest">ETAPA 0</span>
                            <div class="flex gap-2">
                                <button onclick="reset()" class="p-2 text-slate-400 hover:text-slate-800 transition-colors" title="Reiniciar"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                                
                                <!-- Botones con letra m√°s est√©tica y tama√±o reducido -->
                                <button id="btn-prev" onclick="prev()" class="flex items-center gap-2 px-4 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 border border-slate-200 rounded-lg text-xs font-bold uppercase tracking-wide transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i> Anterior
                                </button>
                                <button id="btn-next" onclick="next()" class="flex items-center gap-2 px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold uppercase tracking-wide shadow-md shadow-blue-200 transition-all hover:shadow-lg active:scale-95">
                                    Seguinte <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>
                        <h3 id="step-title" class="text-xl font-extrabold text-slate-800 mb-2">Estado Inicial</h3>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 min-h-[90px]">
                            <p id="step-desc" class="text-sm text-slate-600 leading-relaxed font-medium italic"></p>
                        </div>
                    </div>

                    <div class="lg:col-span-1 bg-slate-900 p-5 rounded-2xl shadow-xl flex flex-col">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2 border-b border-slate-800 pb-2">
                            <i data-lucide="lock" class="w-3 h-3 text-yellow-500"></i> B√≥veda
                        </h4>
                        <p class="text-[10px] text-slate-400 mb-4 italic leading-tight">
                            Visualiza en tempo real que segredos (claves, tickets) pos√∫e cada actor.
                        </p>
                        <div id="vault-content" class="space-y-4 flex-1"></div>
                    </div>

                    <div class="lg:col-span-1 bg-blue-600 p-5 rounded-2xl shadow-xl flex flex-col justify-center border border-blue-500">
                        <h4 class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="shield" class="w-3 h-3"></i> Seguridade
                        </h4>
                        <p id="keys-info" class="text-xs text-blue-50 font-medium leading-relaxed"></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm hidden" onclick="if(event.target === this) hideModal()">
        <div class="bg-white w-full max-w-lg p-6 rounded-3xl shadow-2xl border border-slate-100 transform transition-transform" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-5 border-b pb-4">
                <h3 id="modal-title" class="font-bold text-slate-800 uppercase tracking-tight text-sm">Detalles do Paquete</h3>
                <button onclick="hideModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <h5 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Estrutura Interna (Campos)</h5>
                    <div id="modal-fields" class="bg-slate-900 rounded-2xl p-4 font-mono text-[11px] text-blue-300 leading-loose"></div>
                </div>
                
                <div class="flex items-start gap-3 bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <i data-lucide="unlock" class="w-5 h-5 text-blue-600 shrink-0 mt-0.5"></i>
                    <div>
                        <h5 class="text-[10px] font-bold text-blue-700 uppercase mb-1">L√≥xica Criptogr√°fica</h5>
                        <p id="modal-logic" class="text-xs text-blue-800 font-medium leading-relaxed"></p>
                    </div>
                </div>

                <div id="modal-threats" class="hidden bg-red-50 p-4 rounded-2xl border border-red-100">
                    <h5 class="text-xs font-bold text-red-700 mb-2 flex items-center gap-2 italic">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i> Vulnerabilidades / Ataques:
                    </h5>
                    <div id="threat-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const steps = [
            {
                title: "Estado Inicial", phase: "Configuraci√≥n",
                desc: "Antes de comezar, o KDC co√±ece os contrasinais (hashes) de todos. O usuario co√±ece o seu. O servizo co√±ece o seu.",
                analogy: "Est√°s na entrada dun parque de atracci√≥ns. Tes o teu DNI, pero a√≠nda non tes ningunha entrada nin pase.",
                keysInfo: "Segredos compartidos: O AD almacena os hashes NTLM. Estes son os 'segredos' que permiten confiar sen enviar contrasinais pola rede.",
                actors: { client: 'idle', as: 'idle', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Contrasinal Usuario"], kdc: ["Hash Usuario", "Hash krbtgt", "Hash Servizo"], service: ["Hash Servizo"] }
            },
            {
                title: "KRB_AS_REQ", packet: { from: 'client', to: 'as', label: 'AS_REQ', icon: 'user' },
                phase: "Identificaci√≥n",
                desc: "O cliente solicita un TGT enviando o seu ID e un timestamp cifrado coa s√∫a propia clave para pre-autenticaci√≥n.",
                analogy: "Vas √° Xanela 1 (AS). Dis quen √©s e ensinas o teu DNI para demostralo.",
                keysInfo: "üîê Cifrado co Hash NTLM do Usuario. O AS descifra isto usando a copia que ten na s√∫a base de datos.",
                actors: { client: 'active', as: 'waiting', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Contrasinal Usuario"], kdc: ["Hash Usuario", "Hash krbtgt"], service: ["Hash Servizo"] },
                details: { 
                    fields: ["cname: username", "padata: timestamp cifrado", "nonce: num aleatorio"], 
                    logic: "Usa o Hash do Usuario para cifrar. Se o AS pode descifralo, sabe que o usuario √© real.",
                    threats: [{ name: "AS-REP Roasting", desc: "Se non hai pre-autenticaci√≥n, calquera pode pedir este paso e crackear a resposta offline." }]
                }
            },
            {
                title: "KRB_AS_REP", packet: { from: 'as', to: 'client', label: 'AS_REP', icon: 'lock', subIcon: 'ticket' },
                phase: "Entrega de Pase (TGT)",
                desc: "O AS entrega o Ticket Granting Ticket (TGT) e unha Session Key. O TGT vai cifrado para que s√≥ o KDC poida lelo.",
                analogy: "A Xanela 1 d√°che unha pulseira (TGT) selada que di que √©s ti. A pulseira est√° selada e non podes abrila.",
                keysInfo: "üîë Clave Mestra: Hash 'krbtgt'. S√≥ o KDC pode ler o que hai dentro do TGT. O usuario s√≥ o 'garda'.",
                actors: { client: 'waiting', as: 'active', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Contrasinal Usuario", "TGT", "Logon Session Key"], kdc: ["Hash krbtgt"], service: ["Hash Servizo"] },
                details: { 
                    fields: ["TGT (Cifrado con krbtgt)", "Logon Session Key (Cifrada con Hash Usuario)"], 
                    logic: "O TGT cont√©n o PAC (privilexios). O usuario non pode ver o seu contido pero debe presentalo para pedir servizos.",
                    threats: [{ name: "Golden Ticket", desc: "Se roubas a clave 'krbtgt', podes fabricar as t√∫as propias pulseiras falsas infinitas (Persistencia total)." }]
                }
            },
            {
                title: "KRB_TGS_REQ", packet: { from: 'client', to: 'tgs', label: 'TGS_REQ', icon: 'ticket' },
                phase: "Pedir Ticket de Atracci√≥n",
                desc: "O usuario presenta o seu TGT ao TGS para pedir acceso a un servidor espec√≠fico (SPN).",
                analogy: "Vas √° Xanela 2 (TGS). Ensinas a t√∫a pulseira (TGT) e pides un ticket para a Monta√±a Rusa (Servizo).",
                keysInfo: "üîì Descifrando TGT: O TGS usa o Hash 'krbtgt' compartido co AS para abrir a pulseira.",
                actors: { client: 'active', as: 'idle', tgs: 'waiting', service: 'idle' },
                vaults: { client: ["Logon Session Key", "TGT (Cerrado)"], kdc: ["Hash krbtgt"], service: ["Hash Servizo"] },
                details: { 
                    fields: ["TGT", "Authenticator", "SPN (Service Name)"], 
                    logic: "O TGS usa a clave 'krbtgt' para abrir o TGT e ver se o usuario segue sendo v√°lido e quen √©.",
                    threats: [{ name: "Pass-The-Ticket", desc: "Se roubas unha pulseira (TGT) da memoria LSASS doutro, podes pedir tickets no seu nome." }]
                }
            },
            {
                title: "KRB_TGS_REP", packet: { from: 'tgs', to: 'client', label: 'TGS_REP', icon: 'file-text', subIcon: 'key' },
                phase: "Entrega Ticket de Servizo",
                desc: "O TGS entrega un Service Ticket cifrado coa clave do servidor destino.",
                analogy: "A Xanela 2 comproba a t√∫a pulseira e d√°che o ticket da Monta√±a Rusa.",
                keysInfo: "üîê Cifrado con: Hash do Servizo. S√≥ o File Server poder√° abrir este ticket final.",
                actors: { client: 'waiting', as: 'idle', tgs: 'active', service: 'idle' },
                vaults: { client: ["Logon Session Key", "Service Session Key"], kdc: ["Hash Servizo"], service: ["Hash Servizo"] },
                details: { 
                    fields: ["Service Ticket (Cifrado con clave Servizo)", "Service Session Key"], 
                    logic: "O ticket cont√©n o PAC cos grupos de seguridade. O KDC delega a confianza ao ticket.",
                    threats: [{ name: "Kerberoasting", desc: "O ticket est√° cifrado co hash do servizo. Se √© un contrasinal d√©bil, crack√©ase f√°cil." }]
                }
            },
            {
                title: "KRB_AP_REQ", packet: { from: 'client', to: 'service', label: 'AP_REQ', icon: 'shield' },
                phase: "Acceso ao Recurso",
                desc: "O cliente env√≠a o Service Ticket ao servidor final. O servidor √°breo coa s√∫a propia clave.",
                analogy: "Chegas √° Monta√±a Rusa e entregas o ticket ao operario.",
                keysInfo: "üîì O servidor usa o seu propio Hash NTLM para abrir o ticket. Se o PAC di que √©s Admin, d√©ixate pasar.",
                actors: { client: 'active', as: 'idle', tgs: 'idle', service: 'waiting' },
                vaults: { client: ["Service Ticket (Cerrado)"], service: ["Hash Servizo"] },
                details: { 
                    fields: ["Service Ticket", "Authenticator"], 
                    logic: "O servidor non necesita falar co KDC; conf√≠a en que s√≥ o KDC puido cifrar ese ticket coa s√∫a clave.",
                    threats: [{ name: "Silver Ticket", desc: "Se roubas a clave do operario (Servizo), podes inventar tickets de atracci√≥n ti mesmo." }]
                }
            },
            {
                title: "Acceso Concedido", packet: { from: 'service', to: 'client', label: 'AP_REP', icon: 'check-circle' },
                phase: "Finalizaci√≥n",
                desc: "Autenticaci√≥n completada! O servizo xa sabe quen √©s sen haber visto nunca o teu contrasinal.",
                analogy: "Est√°s a gozar da atracci√≥n! O operario sabe que pagaches porque o ticket era aut√©ntico.",
                keysInfo: "Resultado: Confianza mutua establecida mediante criptograf√≠a de clave sim√©trica.",
                actors: { client: 'success', as: 'idle', tgs: 'idle', service: 'success' },
                vaults: { client: ["Sesi√≥n OK"], service: ["Identidade OK"] },
                details: { 
                    fields: ["Confirmaci√≥n de tiempo"], 
                    logic: "O servizo confirma ao cliente que √© lex√≠timo e que puido descifrar o ticket.", 
                    threats: [] 
                }
            }
        ];

        let currentStep = 0;
        let mode = 'technical';
        let isAnimating = false;

        const positions = {
            client: { left: '10%', top: '65%' },
            as: { left: '42%', top: '25%' },
            tgs: { left: '58%', top: '25%' },
            service: { left: '90%', top: '65%' }
        };

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('btn-mode-tech').className = `flex items-center gap-2 px-4 py-2 rounded-md text-xs font-semibold transition-all ${mode==='technical'?'bg-white text-blue-600 shadow-sm border border-slate-100':'text-slate-500 hover:text-slate-700 hover:bg-slate-100'}`;
            document.getElementById('btn-mode-analogy').className = `flex items-center gap-2 px-4 py-2 rounded-md text-xs font-semibold transition-all ${mode==='analogy'?'bg-white text-orange-600 shadow-sm border border-slate-100':'text-slate-500 hover:text-slate-700 hover:bg-slate-100'}`;
            updateUI();
        }

        function updateActor(id, state) {
            const el = document.getElementById(`actor-${id}`);
            if (!el) return;
            
            // Limpiar clases de estado previas
            el.classList.remove('actor-idle', 'actor-active', 'actor-waiting', 'actor-success', 'border-slate-200', 'text-slate-300', 'border-blue-500', 'text-blue-600', 'shadow-2xl', 'scale-110', 'border-orange-400', 'text-orange-500', 'animate-pulse', 'border-green-500', 'text-green-600');
            
            // A√±adir clase base y de estado
            if (state === 'active') el.classList.add('border-blue-500', 'text-blue-600', 'shadow-2xl', 'scale-110');
            else if (state === 'waiting') el.classList.add('border-orange-400', 'text-orange-500', 'animate-pulse');
            else if (state === 'success') el.classList.add('border-green-500', 'text-green-600', 'shadow-2xl', 'scale-110');
            else el.classList.add('border-slate-200', 'text-slate-300');
        }

        function updateUI() {
            const data = steps[currentStep];
            document.getElementById('step-badge').innerText = `ETAPA ${currentStep}`;
            document.getElementById('step-title').innerText = data.title;
            document.getElementById('step-desc').innerText = mode === 'analogy' ? data.analogy : data.desc;
            document.getElementById('keys-info').innerText = data.keysInfo;
            document.getElementById('progress-bar').style.width = `${(currentStep / (steps.length - 1)) * 100}%`;
            
            updateActor('as', data.actors.as);
            updateActor('tgs', data.actors.tgs);
            updateActor('client', data.actors.client);
            updateActor('service', data.actors.service);

            // Update Vaults
            const vault = document.getElementById('vault-content');
            vault.innerHTML = '';
            Object.entries(data.vaults).forEach(([actor, items]) => {
                // Traducci√≥n din√°mica de etiquetas
                let label = actor;
                if(actor === 'client') label = 'Usuario';
                else if(actor === 'kdc') label = 'KDC';
                else if(actor === 'service') label = 'Servizo';

                let html = `<div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-500 uppercase">${label}</span><div class="flex flex-wrap gap-1">`;
                items.forEach(it => html += `<span class="px-2 py-0.5 bg-slate-800 text-[9px] text-slate-300 rounded border border-slate-700 flex items-center gap-1"><i data-lucide="key" class="w-2 h-2 text-yellow-500"></i>${it}</span>`);
                vault.innerHTML += html + `</div></div>`;
            });

            // Update Inventory Icons
            const inv = document.getElementById('client-inventory');
            inv.innerHTML = '';
            if (currentStep >= 3) inv.innerHTML += `<div class="p-1 bg-yellow-400 text-white rounded shadow-sm" title="TGT"><i data-lucide="ticket" class="w-3.5 h-3.5"></i></div>`;
            if (currentStep >= 5) inv.innerHTML += `<div class="p-1 bg-green-500 text-white rounded shadow-sm" title="Service Ticket"><i data-lucide="key" class="w-3.5 h-3.5"></i></div>`;

            // Buttons state
            document.getElementById('btn-prev').disabled = (currentStep === 0 || isAnimating);
            document.getElementById('btn-next').disabled = (currentStep === steps.length - 1 || isAnimating);
            document.getElementById('btn-next').innerHTML = currentStep === steps.length - 1 ? 
                `Rematado <i data-lucide="check" class="w-3.5 h-3.5"></i>` : 
                `Seguinte <i data-lucide="arrow-right" class="w-3.5 h-3.5"></i>`;
            document.getElementById('btn-next').className = currentStep === steps.length - 1 ?
                "flex items-center gap-2 px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-bold uppercase tracking-wide shadow-md transition-all hover:shadow-lg active:scale-95" :
                "flex items-center gap-2 px-5 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold uppercase tracking-wide shadow-md shadow-blue-200 transition-all hover:shadow-lg active:scale-95";

            handlePacket();
            lucide.createIcons();
        }

        function handlePacket() {
            const pkt = steps[currentStep].packet;
            const pEl = document.getElementById('packet');
            if (!pkt) { pEl.classList.add('hidden'); return; }
            pEl.classList.remove('hidden');
            document.getElementById('packet-label').innerText = pkt.label;
            document.getElementById('packet-icons').innerHTML = `<i data-lucide="${pkt.icon}" class="w-4 h-4"></i>`;
            if (pkt.subIcon) document.getElementById('packet-icons').innerHTML += `<i data-lucide="${pkt.subIcon}" class="w-3 h-3"></i>`;
            
            const start = positions[pkt.from];
            const end = positions[pkt.to];
            
            pEl.style.transition = 'none';
            pEl.style.left = start.left; 
            pEl.style.top = start.top; 
            pEl.style.opacity = '0';

            setTimeout(() => {
                isAnimating = true;
                updateButtonsState(); // Deshabilitar botones durante animaci√≥n
                pEl.style.transition = 'all 1s cubic-bezier(0.4, 0, 0.2, 1)';
                pEl.style.left = end.left; 
                pEl.style.top = end.top; 
                pEl.style.opacity = '1';
                setTimeout(() => { 
                    isAnimating = false; 
                    updateButtonsState();
                    lucide.createIcons(); 
                }, 1000);
            }, 50);
        }

        function updateButtonsState() {
            document.getElementById('btn-prev').disabled = (currentStep === 0 || isAnimating);
            document.getElementById('btn-next').disabled = (currentStep === steps.length - 1 || isAnimating);
        }

        function next() { 
            if (currentStep < steps.length - 1 && !isAnimating) { 
                currentStep++; 
                updateUI(); 
            } 
        }

        function prev() {
            if (currentStep > 0 && !isAnimating) {
                currentStep--;
                updateUI();
            }
        }

        function reset() { currentStep = 0; updateUI(); }

        function showModal() {
            const d = steps[currentStep].details;
            if (!d) return;
            document.getElementById('modal-fields').innerHTML = d.fields.map(f => `<div>‚ûú ${f}</div>`).join('');
            document.getElementById('modal-logic').innerText = d.logic;
            
            const threatsEl = document.getElementById('modal-threats');
            const listEl = document.getElementById('threat-list');
            if (d.threats && d.threats.length > 0) {
                threatsEl.classList.remove('hidden');
                listEl.innerHTML = '';
                d.threats.forEach(t => {
                    listEl.innerHTML += `<p class="text-[11px] text-red-600 leading-tight"><span class="font-bold underline">${t.name}:</span> ${t.desc}</p>`;
                });
            } else {
                threatsEl.classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }
        function hideModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = () => updateUI();
    </script>
</body>
</html>
