<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerberos MasterClass - Simulaci√≥n Interactiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }
        .packet-transition {
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .actor-transition {
            transition: all 0.3s ease;
        }
        .step-indicator-transition {
            transition: width 0.5s ease-out;
        }
        /* Estilos para estados de los actores */
        .actor-idle { @apply border-slate-200 text-slate-300 bg-white; }
        .actor-active { @apply border-blue-500 text-blue-600 bg-white shadow-2xl scale-110; }
        .actor-waiting { @apply border-orange-400 text-orange-500 bg-white animate-pulse; }
        .actor-success { @apply border-green-500 text-green-600 bg-white shadow-2xl scale-110; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col relative">
        
        <!-- HEADER -->
        <header class="p-6 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white z-10">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight flex items-center gap-3">
                    <i data-lucide="shield-check" class="text-blue-600 w-8 h-8"></i>
                    Kerberos <span class="text-blue-600">MasterClass</span>
                </h1>
                <p class="text-slate-400 text-sm font-medium">Simulaci√≥n Interactiva de Seguridad en Active Directory</p>
            </div>
            
            <div class="flex bg-slate-100 p-1 rounded-xl shadow-inner border border-slate-200">
                <button id="btn-mode-tech" onclick="setMode('technical')" class="flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white text-blue-600 shadow-sm">
                    <i data-lucide="binary" class="w-3.5 h-3.5"></i> Modo T√©cnico
                </button>
                <button id="btn-mode-analogy" onclick="setMode('analogy')" class="flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-500 hover:text-slate-700">
                    <i data-lucide="layout" class="w-3.5 h-3.5"></i> Modo Estudiante
                </button>
            </div>
        </header>

        <div class="flex flex-1 relative">
            <!-- SIDEBAR GLOSARIO -->
            <aside class="w-48 p-5 border-r border-slate-100 bg-slate-50/50 hidden xl:block">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i data-lucide="book-open" class="w-3 h-3"></i> Glosario
                </h4>
                <div class="space-y-5">
                    <div>
                        <p class="text-[10px] font-bold text-blue-700">NTLM Hash</p>
                        <p class="text-[9px] text-slate-500 leading-relaxed">Contrase√±a 'disfrazada'. Nunca se env√≠a en claro por la red.</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-indigo-700">PAC</p>
                        <p class="text-[9px] text-slate-500 leading-relaxed">Lista de tus privilegios y grupos de seguridad del dominio.</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-orange-700">SPN</p>
                        <p class="text-[9px] text-slate-500 leading-relaxed">Nombre '√∫nico' del servicio solicitado (ej: cifs/servidor).</p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-green-700">Authenticator</p>
                        <p class="text-[9px] text-slate-500 leading-relaxed">Prueba temporal de identidad para evitar reenv√≠os.</p>
                    </div>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="flex-1 p-6 flex flex-col gap-6">
                
                <!-- DIAGRAMA -->
                <div class="relative w-full h-[400px] bg-white rounded-3xl border border-slate-100 shadow-inner overflow-hidden select-none" id="diagram-container">
                    <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-20 z-0">
                        <path d="M 120 260 C 120 150, 350 200, 400 120" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="8,8" />
                        <path d="M 140 260 C 140 150, 550 200, 580 120" stroke="#3b82f6" stroke-width="2" fill="none" stroke-dasharray="8,8" />
                        <line x1="15%" y1="65%" x2="85%" y2="65%" stroke="#3b82f6" stroke-width="2" stroke-dasharray="8,8" />
                    </svg>

                    <!-- KDC BOX -->
                    <div class="absolute top-[5%] left-1/2 -translate-x-1/2 w-[380px] h-[170px] border-2 border-dashed border-blue-100 rounded-[2.5rem] bg-blue-50/10 flex flex-col items-center pt-2">
                        <span class="text-[9px] font-black text-blue-300 uppercase tracking-widest bg-white px-3 py-1 border border-blue-50 rounded-full shadow-sm mb-2">KDC</span>
                        <div class="flex w-full justify-around items-center h-full pb-4">
                            <div id="actor-as" class="actor-transition flex flex-col items-center p-3 rounded-2xl border-4 bg-white text-slate-300">
                                <i data-lucide="database" class="w-7 h-7"></i>
                                <span class="text-[10px] font-black mt-1 uppercase">AS</span>
                            </div>
                            <div class="flex flex-col items-center opacity-20 scale-75">
                                <div class="p-2 bg-yellow-400 rounded-lg text-white"><i data-lucide="key" class="w-5 h-5"></i></div>
                            </div>
                            <div id="actor-tgs" class="actor-transition flex flex-col items-center p-3 rounded-2xl border-4 bg-white text-slate-300">
                                <i data-lucide="ticket" class="w-7 h-7"></i>
                                <span class="text-[10px] font-black mt-1 uppercase">TGS</span>
                            </div>
                        </div>
                    </div>

                    <!-- CLIENTE -->
                    <div class="absolute top-[65%] left-[12%] -translate-x-1/2 flex flex-col items-center">
                        <div id="actor-client" class="actor-transition w-24 h-24 rounded-3xl flex items-center justify-center border-4 border-slate-200 bg-white text-slate-300 shadow-lg">
                            <i data-lucide="user" class="w-10 h-10"></i>
                        </div>
                        <div class="mt-3 text-center">
                            <p class="font-black text-sm text-slate-700">Usuario</p>
                            <div id="client-inventory" class="flex gap-1 justify-center mt-2 h-6"></div>
                        </div>
                    </div>

                    <!-- SERVICIO -->
                    <div class="absolute top-[65%] right-[12%] translate-x-1/2 flex flex-col items-center">
                        <div id="actor-service" class="actor-transition w-24 h-24 rounded-3xl flex items-center justify-center border-4 border-slate-200 bg-white text-slate-300 shadow-lg">
                            <i data-lucide="server" class="w-10 h-10"></i>
                        </div>
                        <p class="mt-3 font-black text-sm text-slate-700">Servidor (AP)</p>
                    </div>

                    <!-- PAQUETE -->
                    <div id="packet" onclick="showModal()" class="packet-transition absolute z-30 cursor-pointer hidden group">
                        <div class="relative flex flex-col items-center justify-center w-28 h-20 bg-white border-2 border-blue-600 rounded-2xl shadow-2xl bg-gradient-to-br from-white to-blue-50 ring-4 ring-blue-500/10 hover:scale-105 transition-transform">
                            <div id="packet-icons" class="flex items-center gap-2 text-blue-700 mb-1"></div>
                            <span id="packet-label" class="text-[11px] font-black text-slate-700"></span>
                            <span class="text-[7px] font-black text-blue-600 animate-pulse mt-1 uppercase">¬°Clic para abrir!</span>
                            <div class="absolute -top-1 -right-1 h-3 w-3 bg-blue-500 rounded-full animate-ping"></div>
                        </div>
                    </div>
                </div>

                <!-- CONTROLES -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 h-1 bg-blue-100 w-full">
                            <div id="progress-bar" class="h-full bg-blue-600 step-indicator-transition" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between items-center mb-4 pt-2">
                            <span id="step-badge" class="px-3 py-1 bg-slate-900 text-white rounded-full text-[10px] font-black tracking-widest">ETAPA 0</span>
                            <div class="flex gap-2">
                                <button onclick="reset()" class="p-2 text-slate-300 hover:text-slate-800 transition-colors" title="Reiniciar"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                                <!-- Bot√≥n Anterior A√±adido -->
                                <button id="btn-prev" onclick="prev()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-sm font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Anterior
                                </button>
                                <button id="btn-next" onclick="next()" class="flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-black shadow-lg shadow-blue-200">
                                    Siguiente <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        <h3 id="step-title" class="text-xl font-black text-slate-800 mb-2">Estado Inicial</h3>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100 min-h-[90px]">
                            <p id="step-desc" class="text-sm text-slate-600 leading-relaxed font-medium italic"></p>
                        </div>
                    </div>

                    <div class="lg:col-span-1 bg-slate-900 p-5 rounded-2xl shadow-xl flex flex-col">
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2 border-b border-slate-800 pb-2">
                            <i data-lucide="lock" class="w-3 h-3 text-yellow-500"></i> B√≥veda
                        </h4>
                        <div id="vault-content" class="space-y-4 flex-1"></div>
                    </div>

                    <div class="lg:col-span-1 bg-blue-600 p-5 rounded-2xl shadow-xl flex flex-col justify-center border border-blue-500">
                        <h4 class="text-[10px] font-black text-blue-200 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <i data-lucide="shield" class="w-3 h-3"></i> Seguridad
                        </h4>
                        <p id="keys-info" class="text-xs text-blue-50 font-medium leading-relaxed"></p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm hidden" onclick="if(event.target === this) hideModal()">
        <div class="bg-white w-full max-w-lg p-6 rounded-3xl shadow-2xl border border-slate-100 transform transition-transform" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-5 border-b pb-4">
                <h3 id="modal-title" class="font-black text-slate-800 uppercase tracking-tight">Detalles del Paquete</h3>
                <button onclick="hideModal()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h5 class="text-[10px] font-black text-slate-400 uppercase mb-2">Estructura Interna (Campos)</h5>
                    <div id="modal-fields" class="bg-slate-900 rounded-2xl p-4 font-mono text-[11px] text-blue-300 leading-loose"></div>
                </div>
                
                <div class="flex items-start gap-3 bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <i data-lucide="unlock" class="w-5 h-5 text-blue-600 shrink-0 mt-0.5"></i>
                    <div>
                        <h5 class="text-[10px] font-bold text-blue-700 uppercase mb-1">L√≥gica Criptogr√°fica</h5>
                        <p id="modal-logic" class="text-xs text-blue-800 font-medium leading-relaxed"></p>
                    </div>
                </div>

                <div id="modal-threats" class="hidden bg-red-50 p-4 rounded-2xl border border-red-100">
                    <h5 class="text-xs font-bold text-red-700 mb-2 flex items-center gap-2 italic">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i> Vulnerabilidades / Ataques:
                    </h5>
                    <div id="threat-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const steps = [
            {
                title: "Estado Inicial", phase: "Configuraci√≥n",
                desc: "Antes de empezar, el KDC conoce las contrase√±as (hashes) de todos. El usuario conoce la suya. El servicio conoce la suya.",
                analogy: "Est√°s en la entrada de un parque de atracciones. Tienes tu DNI, pero a√∫n no tienes ninguna entrada ni pase.",
                keysInfo: "Secretos compartidos: El AD almacena los hashes NTLM. Estos son los 'secretos' que permiten confiar sin enviar contrase√±as por la red.",
                actors: { client: 'idle', as: 'idle', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Pass Usuario"], kdc: ["Hash Usuario", "Hash krbtgt", "Hash Servicio"], service: ["Hash Servicio"] }
            },
            {
                title: "KRB_AS_REQ", packet: { from: 'client', to: 'as', label: 'AS_REQ', icon: 'user' },
                phase: "Identificaci√≥n",
                desc: "El cliente solicita un TGT enviando su ID y un timestamp cifrado con su propia clave para pre-autenticaci√≥n.",
                analogy: "Vas a la Ventanilla 1 (AS). Dices qui√©n eres y ense√±as tu DNI para demostrarlo.",
                keysInfo: "üîê Cifrado con Hash NTLM del Usuario. El AS descifra esto usando la copia que tiene en su base de datos.",
                actors: { client: 'active', as: 'waiting', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Pass Usuario"], kdc: ["Hash Usuario", "Hash krbtgt"], service: ["Hash Servicio"] },
                details: { 
                    fields: ["cname: username", "padata: timestamp cifrado", "nonce: num aleatorio"], 
                    logic: "Usa el Hash del Usuario para cifrar. Si el AS puede descifrarlo, sabe que el usuario es real.",
                    threats: [{ name: "AS-REP Roasting", desc: "Si no hay pre-autenticaci√≥n, cualquiera puede pedir este paso y crackear la respuesta offline." }]
                }
            },
            {
                title: "KRB_AS_REP", packet: { from: 'as', to: 'client', label: 'AS_REP', icon: 'lock', subIcon: 'ticket' },
                phase: "Entrega de Pase (TGT)",
                desc: "El AS entrega el Ticket Granting Ticket (TGT) y una Session Key. El TGT va cifrado para que solo el KDC pueda leerlo.",
                analogy: "La Ventanilla 1 te da una pulsera (TGT) sellada que dice que eres t√∫. La pulsera est√° sellada y no puedes abrirla.",
                keysInfo: "üîë Clave Maestra: Hash 'krbtgt'. Solo el KDC puede leer lo que hay dentro del TGT. El usuario solo lo 'guarda'.",
                actors: { client: 'waiting', as: 'active', tgs: 'idle', service: 'idle' },
                vaults: { client: ["Pass Usuario", "TGT", "Logon Session Key"], kdc: ["Hash krbtgt"], service: ["Hash Servicio"] },
                details: { 
                    fields: ["TGT (Cifrado con krbtgt)", "Logon Session Key (Cifrada con Hash Usuario)"], 
                    logic: "El TGT contiene el PAC (privilegios). El usuario no puede ver su contenido pero debe presentarlo para pedir servicios.",
                    threats: [{ name: "Golden Ticket", desc: "Si robas la clave 'krbtgt', puedes fabricar tus propias pulseras falsas infinitas (Persistencia total)." }]
                }
            },
            {
                title: "KRB_TGS_REQ", packet: { from: 'client', to: 'tgs', label: 'TGS_REQ', icon: 'ticket' },
                phase: "Pedir Ticket de Atracci√≥n",
                desc: "El usuario presenta su TGT al TGS para pedir acceso a un servidor espec√≠fico (SPN).",
                analogy: "Vas a la Ventanilla 2 (TGS). Ense√±as tu pulsera (TGT) y pides un ticket para la Monta√±a Rusa (Servicio).",
                keysInfo: "üîì Descifrando TGT: El TGS usa el Hash 'krbtgt' compartido con el AS para abrir la pulsera.",
                actors: { client: 'active', as: 'idle', tgs: 'waiting', service: 'idle' },
                vaults: { client: ["Logon Session Key", "TGT (Cerrado)"], kdc: ["Hash krbtgt"], service: ["Hash Servicio"] },
                details: { 
                    fields: ["TGT", "Authenticator", "SPN (Service Name)"], 
                    logic: "El TGS usa la clave 'krbtgt' para abrir el TGT y ver si el usuario sigue siendo v√°lido y qui√©n es.",
                    threats: [{ name: "Pass-The-Ticket", desc: "Si robas una pulsera (TGT) de la memoria LSASS de otro, puedes pedir tickets en su nombre." }]
                }
            },
            {
                title: "KRB_TGS_REP", packet: { from: 'tgs', to: 'client', label: 'TGS_REP', icon: 'file-text', subIcon: 'key' },
                phase: "Entrega Ticket de Servicio",
                desc: "El TGS entrega un Service Ticket cifrado con la clave del servidor destino.",
                analogy: "La Ventanilla 2 comprueba tu pulsera y te da el ticket de la Monta√±a Rusa.",
                keysInfo: "üîê Cifrado con: Hash del Servicio. Solo el File Server podr√° abrir este ticket final.",
                actors: { client: 'waiting', as: 'idle', tgs: 'active', service: 'idle' },
                vaults: { client: ["Logon Session Key", "Service Session Key"], kdc: ["Hash Servicio"], service: ["Hash Servicio"] },
                details: { 
                    fields: ["Service Ticket (Cifrado con clave Servicio)", "Service Session Key"], 
                    logic: "El ticket contiene el PAC con los grupos de seguridad. El KDC delega la confianza al ticket.",
                    threats: [{ name: "Kerberoasting", desc: "El ticket est√° cifrado con el hash del servicio. Si es una pass d√©bil, se crackea f√°cil." }]
                }
            },
            {
                title: "KRB_AP_REQ", packet: { from: 'client', to: 'service', label: 'AP_REQ', icon: 'shield' },
                phase: "Acceso al Recurso",
                desc: "El cliente env√≠a el Service Ticket al servidor final. El servidor lo abre con su propia clave.",
                analogy: "Llegas a la Monta√±a Rusa y entregas el ticket al operario.",
                keysInfo: "üîì El servidor usa su propio Hash NTLM para abrir el ticket. Si el PAC dice que eres Admin, te deja pasar.",
                actors: { client: 'active', as: 'idle', tgs: 'idle', service: 'waiting' },
                vaults: { client: ["Service Ticket (Cerrado)"], service: ["Hash Servicio"] },
                details: { 
                    fields: ["Service Ticket", "Authenticator"], 
                    logic: "El servidor no necesita hablar con el KDC; conf√≠a en que solo el KDC pudo cifrar ese ticket con su clave.",
                    threats: [{ name: "Silver Ticket", desc: "Si robas la clave del operario (Servicio), puedes inventar tickets de atracci√≥n t√∫ mismo." }]
                }
            },
            {
                title: "Acceso Concedido", packet: { from: 'service', to: 'client', label: 'AP_REP', icon: 'check-circle' },
                phase: "Finalizaci√≥n",
                desc: "¬°Autenticaci√≥n completada! El servicio ya sabe qui√©n eres sin haber visto nunca tu contrase√±a.",
                analogy: "¬°Est√°s disfrutando de la atracci√≥n! El operario sabe que pagaste porque el ticket era aut√©ntico.",
                keysInfo: "Resultado: Confianza mutua establecida mediante criptograf√≠a de clave sim√©trica.",
                actors: { client: 'success', as: 'idle', tgs: 'idle', service: 'success' },
                vaults: { client: ["Sesi√≥n OK"], service: ["Identidad OK"] },
                details: { 
                    fields: ["Confirmaci√≥n de tiempo"], 
                    logic: "El servicio confirma al cliente que es leg√≠timo y que ha podido descifrar el ticket.", 
                    threats: [] 
                }
            }
        ];

        let currentStep = 0;
        let mode = 'technical';
        let isAnimating = false;

        const positions = {
            client: { left: '10%', top: '65%' },
            as: { left: '42%', top: '25%' },
            tgs: { left: '58%', top: '25%' },
            service: { left: '90%', top: '65%' }
        };

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('btn-mode-tech').className = `flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode==='technical'?'bg-white text-blue-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            document.getElementById('btn-mode-analogy').className = `flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-bold transition-all ${mode==='analogy'?'bg-white text-orange-600 shadow-sm':'text-slate-500 hover:text-slate-700'}`;
            updateUI();
        }

        function updateActor(id, state) {
            const el = document.getElementById(`actor-${id}`);
            if (!el) return;
            
            // Limpiar clases de estado previas
            el.classList.remove('actor-idle', 'actor-active', 'actor-waiting', 'actor-success', 'border-slate-200', 'text-slate-300', 'border-blue-500', 'text-blue-600', 'shadow-2xl', 'scale-110', 'border-orange-400', 'text-orange-500', 'animate-pulse', 'border-green-500', 'text-green-600');
            
            // A√±adir clase base y de estado
            if (state === 'active') el.classList.add('border-blue-500', 'text-blue-600', 'shadow-2xl', 'scale-110');
            else if (state === 'waiting') el.classList.add('border-orange-400', 'text-orange-500', 'animate-pulse');
            else if (state === 'success') el.classList.add('border-green-500', 'text-green-600', 'shadow-2xl', 'scale-110');
            else el.classList.add('border-slate-200', 'text-slate-300');
        }

        function updateUI() {
            const data = steps[currentStep];
            document.getElementById('step-badge').innerText = `ETAPA ${currentStep}`;
            document.getElementById('step-title').innerText = data.title;
            document.getElementById('step-desc').innerText = mode === 'analogy' ? data.analogy : data.desc;
            document.getElementById('keys-info').innerText = data.keysInfo;
            document.getElementById('progress-bar').style.width = `${(currentStep / (steps.length - 1)) * 100}%`;
            
            updateActor('as', data.actors.as);
            updateActor('tgs', data.actors.tgs);
            updateActor('client', data.actors.client);
            updateActor('service', data.actors.service);

            // Update Vaults
            const vault = document.getElementById('vault-content');
            vault.innerHTML = '';
            Object.entries(data.vaults).forEach(([actor, items]) => {
                let html = `<div class="flex flex-col gap-1"><span class="text-[9px] font-bold text-slate-500 uppercase">${actor}</span><div class="flex flex-wrap gap-1">`;
                items.forEach(it => html += `<span class="px-2 py-0.5 bg-slate-800 text-[9px] text-slate-300 rounded border border-slate-700 flex items-center gap-1"><i data-lucide="key" class="w-2 h-2 text-yellow-500"></i>${it}</span>`);
                vault.innerHTML += html + `</div></div>`;
            });

            // Update Inventory Icons
            const inv = document.getElementById('client-inventory');
            inv.innerHTML = '';
            if (currentStep >= 3) inv.innerHTML += `<div class="p-1 bg-yellow-400 text-white rounded shadow-sm" title="TGT"><i data-lucide="ticket" class="w-3.5 h-3.5"></i></div>`;
            if (currentStep >= 5) inv.innerHTML += `<div class="p-1 bg-green-500 text-white rounded shadow-sm" title="Service Ticket"><i data-lucide="key" class="w-3.5 h-3.5"></i></div>`;

            // Buttons state
            document.getElementById('btn-prev').disabled = (currentStep === 0 || isAnimating);
            document.getElementById('btn-next').disabled = (currentStep === steps.length - 1 || isAnimating);
            document.getElementById('btn-next').innerHTML = currentStep === steps.length - 1 ? 
                `Finalizado <i data-lucide="check" class="w-4 h-4"></i>` : 
                `Siguiente <i data-lucide="arrow-right" class="w-4 h-4"></i>`;
            document.getElementById('btn-next').className = currentStep === steps.length - 1 ?
                "flex items-center gap-2 px-6 py-2 bg-green-500 text-white rounded-xl text-sm font-black shadow-lg" :
                "flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-black shadow-lg shadow-blue-200";

            handlePacket();
            lucide.createIcons();
        }

        function handlePacket() {
            const pkt = steps[currentStep].packet;
            const pEl = document.getElementById('packet');
            if (!pkt) { pEl.classList.add('hidden'); return; }
            pEl.classList.remove('hidden');
            document.getElementById('packet-label').innerText = pkt.label;
            document.getElementById('packet-icons').innerHTML = `<i data-lucide="${pkt.icon}" class="w-4 h-4"></i>`;
            if (pkt.subIcon) document.getElementById('packet-icons').innerHTML += `<i data-lucide="${pkt.subIcon}" class="w-3 h-3"></i>`;
            
            const start = positions[pkt.from];
            const end = positions[pkt.to];
            
            // Si estamos retrocediendo o reseteando, colocamos el paquete en su posici√≥n final sin animar (o inicial)
            // Para mantener la consistencia visual, siempre animamos hacia adelante al cambiar de paso
            pEl.style.transition = 'none';
            pEl.style.left = start.left; 
            pEl.style.top = start.top; 
            pEl.style.opacity = '0';

            setTimeout(() => {
                isAnimating = true;
                updateButtonsState(); // Deshabilitar botones durante animaci√≥n
                pEl.style.transition = 'all 1s cubic-bezier(0.4, 0, 0.2, 1)';
                pEl.style.left = end.left; 
                pEl.style.top = end.top; 
                pEl.style.opacity = '1';
                setTimeout(() => { 
                    isAnimating = false; 
                    updateButtonsState();
                    lucide.createIcons(); 
                }, 1000);
            }, 50);
        }

        function updateButtonsState() {
            document.getElementById('btn-prev').disabled = (currentStep === 0 || isAnimating);
            document.getElementById('btn-next').disabled = (currentStep === steps.length - 1 || isAnimating);
        }

        function next() { 
            if (currentStep < steps.length - 1 && !isAnimating) { 
                currentStep++; 
                updateUI(); 
            } 
        }

        function prev() {
            if (currentStep > 0 && !isAnimating) {
                currentStep--;
                updateUI();
            }
        }

        function reset() { currentStep = 0; updateUI(); }

        function showModal() {
            const d = steps[currentStep].details;
            if (!d) return;
            document.getElementById('modal-fields').innerHTML = d.fields.map(f => `<div>‚ûú ${f}</div>`).join('');
            document.getElementById('modal-logic').innerText = d.logic;
            
            const threatsEl = document.getElementById('modal-threats');
            const listEl = document.getElementById('threat-list');
            if (d.threats && d.threats.length > 0) {
                threatsEl.classList.remove('hidden');
                listEl.innerHTML = '';
                d.threats.forEach(t => {
                    listEl.innerHTML += `<p class="text-[11px] text-red-600 leading-tight"><span class="font-bold underline">${t.name}:</span> ${t.desc}</p>`;
                });
            } else {
                threatsEl.classList.add('hidden');
            }

            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }
        function hideModal() { document.getElementById('modal').classList.add('hidden'); }

        window.onload = () => updateUI();
    </script>
</body>
</html>
